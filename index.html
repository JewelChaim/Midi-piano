<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MIDI Songwriter Workstation</title>
<style>
/* Testing: Manual browser checks: play/record, import/export, autosave, quantize/swing, metronome accent */
body{margin:0;font-family:sans-serif;background:#f5f5f5;color:#222;}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:10;}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
main{display:flex;flex-wrap:wrap;padding:10px;gap:10px;}
#melodicPads,#drumPads{background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
#chordPads{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
#notePads{display:flex;flex-wrap:wrap;margin-top:10px;gap:5px;}
#drumPads{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
.pad{width:60px;height:60px;border:none;border-radius:8px;background:#e0e0e0;cursor:pointer;font-size:14px;position:relative;}
.pad.active{background:#ffd54f;}
#timeline{background:#fff;border-radius:8px;padding:10px;margin:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1);min-height:260px;}
.track{position:relative;height:60px;border-bottom:1px solid #ddd;}
.track-label{position:absolute;left:0;top:0;width:80px;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:12px;}
.track-content{margin-left:80px;height:100%;position:relative;}
.clip{position:absolute;height:40px;background:#90caf9;border-radius:4px;color:#000;padding:5px;cursor:move;overflow:hidden;}
.clip.selected{outline:2px solid #f00;}
#cursor{position:absolute;top:0;width:2px;background:red;height:100%;}
#noMidi{display:none;background:#ffcdd2;padding:5px;text-align:center;}
button,select,input{font-size:14px;}
@media(max-width:800px){main{flex-direction:column;}#melodicPads,#drumPads{width:100%;}}
</style>
</head>
<body>
<div id="noMidi">No Web MIDI support</div>
<header>
  <h1>Songwriter</h1>
  <div class="controls">
    <label>Key <select id="keySelect"></select></label>
    <label>Scale <select id="scaleSelect"><option>Major</option><option>Minor</option><option>Dorian</option><option>Mixolydian</option></select></label>
    <label>BPM <input type="number" id="bpm" value="120" style="width:60px"></label>
    <label>Quantize <select id="quantize"><option value="0">Off</option><option value="0.5">1/8</option><option value="0.25">1/16</option><option value="0.125">1/32</option></select></label>
    <label>Swing <input type="range" id="swing" min="0" max="0.6" step="0.05" value="0"> <span id="swingVal">0%</span></label>
    <button id="playBtn" aria-label="Play/Stop">Play</button>
    <button id="recBtn" aria-label="Record">Rec</button>
    <button id="metBtn" aria-label="Metronome">Met</button>
    <button id="newBtn">New Project</button>
    <button id="loadBtn">Load Autosave</button>
    <button id="expBtn">Export JSON</button>
    <button id="impBtn">Import JSON</button>
    <button id="sampleBtn">Sample Project</button>
    <input type="file" id="fileInput" accept="application/json" style="display:none">
  </div>
</header>
<main>
  <div id="melodicPads">
    <div id="chordPads"></div>
    <div id="notePads"></div>
  </div>
  <div id="drumPads"></div>
</main>
<div id="timeline">
  <div id="cursor"></div>
</div>
<script>
// --- Audio & MIDI Setup ---
const AudioCtx = window.AudioContext||window.webkitAudioContext;
const ctx = new AudioCtx();
let firstGesture=false;function resumeAudio(){if(!firstGesture){ctx.resume();firstGesture=true;}}
let midiAccess=null; if(navigator.requestMIDIAccess){navigator.requestMIDIAccess().then(m=>{midiAccess=m;},()=>document.getElementById('noMidi').style.display='block');}else document.getElementById('noMidi').style.display='block';

// --- State ---
const state={tempo:120,key:'C',scale:'Major',quantize:0,swing:0,tracks:{melody:[],backing:[],bass:[],guitar:[],synth:[],drums:[]},clips:[],mixer:{melody:{gain:0.8,pan:0,mute:false,solo:false},backing:{gain:0.8,pan:0,mute:false,solo:false},bass:{gain:0.8,pan:0,mute:false,solo:false},guitar:{gain:0.8,pan:0,mute:false,solo:false},synth:{gain:0.8,pan:0,mute:false,solo:false},drums:{gain:0.8,pan:0,mute:false,solo:false}}};
let recording=false;let currentTrack='melody';

// --- Utilities ---
const noteNames=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function midiToFreq(n){return 440*Math.pow(2,(n-69)/12);}
function now(){return ctx.currentTime;}
function beatsToSeconds(b){return (60/state.tempo)*b;}
function secondsToBeats(s){return s/(60/state.tempo);}
let projectVersion=1;

// --- Transport with playing getter ---
const transport={_playing:false,get playing(){return this._playing;},startTime:0,play(){this._playing=true;this.startTime=now();schedule();},stop(){this._playing=false;}};

// --- Scheduler (look-ahead ~100ms) ---
let lookAhead=0.1;let scheduleId=null;let cursorEl=document.getElementById('cursor');
function schedule(){if(!transport.playing)return;scheduleId=requestAnimationFrame(schedule);const t=now()+lookAhead;playMetronome(t);playTracks(t);updateCursor();}
function updateCursor(){let elapsed=now()-transport.startTime;let beats=secondsToBeats(elapsed);cursorEl.style.left=(beats*40)+'px';}

// --- Metronome ---
let metronome=true;let nextClick=0;function playMetronome(t){if(!metronome) return;const interval=state.quantize?beatsToSeconds(state.quantize):beatsToSeconds(0.5);if(t>=nextClick){const beat=Math.round(secondsToBeats(nextClick));clickSound(beat%4===0?1000:800,nextClick);nextClick+=interval;}}
function clickSound(freq,time){const osc=ctx.createOscillator();const g=ctx.createGain();osc.frequency.value=freq;osc.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(0.7,time);g.gain.exponentialRampToValueAtTime(0.001,time+0.1);osc.start(time);osc.stop(time+0.1);} 

// --- Pads ---
const chordPads=document.getElementById('chordPads');const notePads=document.getElementById('notePads');const drumPads=document.getElementById('drumPads');
const chords=['I','V','vi','IV'];
function buildPads(){notePads.innerHTML='';for(let i=0;i<12;i++){const b=document.createElement('button');b.className='pad';b.textContent=noteNames[i];b.dataset.note=60+i; b.ariaLabel='Note '+noteNames[i];b.addEventListener('mousedown',e=>{resumeAudio();playNote(parseInt(b.dataset.note));if(recording)addEvent('melody',parseInt(b.dataset.note));});notePads.appendChild(b);}drumPads.innerHTML='';['Kick','Snare','Hat','Clap'].forEach((n,i)=>{const b=document.createElement('button');b.className='pad';b.textContent=n;b.dataset.note=36+i; b.ariaLabel='Drum '+n;b.addEventListener('mousedown',()=>{resumeAudio();playNote(parseInt(b.dataset.note));if(recording)addEvent('drums',parseInt(b.dataset.note));});drumPads.appendChild(b);});updateChords();}
function updateChords(){chordPads.innerHTML='';const scaleIntervals={Major:[0,2,4,5,7,9,11],Minor:[0,2,3,5,7,8,10],Dorian:[0,2,3,5,7,9,10],Mixolydian:[0,2,4,5,7,9,10]};const root=noteNames.indexOf(state.key);const scale=scaleIntervals[state.scale];function chordFormula(deg){const idx=['I','II','III','IV','V','VI','VII'].indexOf(deg);const rootNote=root+scale[idx];const triad=[rootNote,(rootNote+4)%12,(rootNote+7)%12];return {name:noteNames[rootNote%12]+(['','m','','','',['m']][idx]||''),notes:triad.map(n=>60+(n%12))};}
chords.forEach(ch=>{const c=chordFormula(ch.toUpperCase());const b=document.createElement('button');b.className='pad';b.textContent=c.name;b.dataset.notes=c.notes.join(',');b.ariaLabel='Chord '+c.name;b.addEventListener('mousedown',()=>{resumeAudio();c.notes.forEach(n=>playNote(n));if(recording)c.notes.forEach(n=>addEvent('backing',n));});chordPads.appendChild(b);});}

// --- Play notes ---
function playNote(n,time=now(),dur=0.5,vel=100){const osc=ctx.createOscillator();osc.frequency.value=midiToFreq(n);const g=ctx.createGain();g.gain.value=vel/127;osc.connect(g);g.connect(ctx.destination);osc.start(time);osc.stop(time+dur);}

// --- Recording ---
let recordStart=0;function addEvent(track,n){const grid=parseFloat(document.getElementById('quantize').value);let t=now()-recordStart;let beats=secondsToBeats(t);if(grid){beats=Math.round(beats/grid)*grid;}const dur=0.5;state.tracks[track].push({t:beats,n,vel:100,dur});saveAutosave();}

// --- Playback of tracks with swing ---
function playTracks(t){const lookBeats=secondsToBeats(lookAhead);for(const track in state.tracks){state.tracks[track].forEach(ev=>{const st=beatsToSeconds(ev.t)+transport.startTime;let when=st;const grid=state.quantize;if(grid){const q=Math.floor(ev.t/grid);if(q%2===1){when+=beatsToSeconds(grid*state.swing);}}if(when>=t-lookAhead&&when<t)playNote(ev.n,when,ev.dur);});}}

// --- Transport buttons ---
const playBtn=document.getElementById('playBtn');const recBtn=document.getElementById('recBtn');const metBtn=document.getElementById('metBtn');playBtn.onclick=()=>{resumeAudio();if(transport.playing){transport.stop();playBtn.textContent='Play';}else{transport.play();playBtn.textContent='Stop';}};recBtn.onclick=()=>{recording=!recording;if(recording){recordStart=now();recBtn.classList.add('active');}else recBtn.classList.remove('active');};metBtn.onclick=()=>{metronome=!metronome;metBtn.classList.toggle('active',metronome);};

// --- Selects ---
const keySelect=document.getElementById('keySelect');noteNames.forEach(n=>{const opt=document.createElement('option');opt.textContent=n;keySelect.appendChild(opt);});keySelect.onchange=()=>{state.key=keySelect.value;updateChords();saveAutosave();};
const scaleSelect=document.getElementById('scaleSelect');scaleSelect.onchange=()=>{state.scale=scaleSelect.value;updateChords();saveAutosave();};
const bpm=document.getElementById('bpm');bpm.onchange=()=>{state.tempo=parseInt(bpm.value);saveAutosave();};
const quant=document.getElementById('quantize');quant.onchange=()=>{state.quantize=parseFloat(quant.value);saveAutosave();};
const swing=document.getElementById('swing');const swingVal=document.getElementById('swingVal');swing.oninput=()=>{state.swing=parseFloat(swing.value);swingVal.textContent=Math.round(state.swing*100)+'%';saveAutosave();};

// --- JSON Import/Export ---
/* Export full project state to JSON file */
function exportProject(){const json=JSON.stringify({version:projectVersion,meta:{app:'MIDI Songwriter Workstation',savedAt:new Date().toISOString()},tempo:state.tempo,key:state.key,scale:state.scale,quantize:state.quantize,swing:state.swing,tracks:state.tracks,clips:state.clips,mixer:state.mixer},null,2);const blob=new Blob([json],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='project.json';a.click();}
/* Import project from JSON with validation */
function importProject(obj){if(!obj||obj.version!==1||typeof obj.tempo!=='number'){toast('Invalid project');return;}Object.assign(state,obj);applyState();toast('Project loaded');}
function applyState(){bpm.value=state.tempo;keySelect.value=state.key;scaleSelect.value=state.scale;quant.value=state.quantize;swing.value=state.swing;swingVal.textContent=Math.round(state.swing*100)+'%';updateChords();}
function toast(msg){const t=document.createElement('div');t.textContent=msg;t.style.position='fixed';t.style.bottom='10px';t.style.left='50%';t.style.transform='translateX(-50%)';t.style.background='#333';t.style.color='#fff';t.style.padding='5px 10px';document.body.appendChild(t);setTimeout(()=>t.remove(),2000);}
const expBtn=document.getElementById('expBtn');expBtn.onclick=exportProject;
const impBtn=document.getElementById('impBtn');const fileInput=document.getElementById('fileInput');impBtn.onclick=()=>fileInput.click();fileInput.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const obj=JSON.parse(ev.target.result);importProject(obj);}catch(err){toast('File error');}};reader.readAsText(file);};

// --- Autosave ---
function saveAutosave(){localStorage.setItem('midiWorkstation',JSON.stringify({version:projectVersion,...state}));}
function loadAutosave(){const json=localStorage.getItem('midiWorkstation');if(json){try{importProject(JSON.parse(json));}catch(e){toast('Autosave corrupted');}}}
const newBtn=document.getElementById('newBtn');const loadBtn=document.getElementById('loadBtn');newBtn.onclick=()=>{if(confirm('New project?')){for(const k in state.tracks)state.tracks[k]=[];state.clips=[];saveAutosave();applyState();}};loadBtn.onclick=()=>{if(confirm('Load autosave?'))loadAutosave();};

// --- Sample Project ---
const sampleProject={version:1,meta:{app:'MIDI Songwriter Workstation',savedAt:''},tempo:120,key:'C',scale:'Major',quantize:0.5,swing:0,tracks:{melody:[{t:0,n:60,vel:100,dur:0.5}],backing:[],bass:[],guitar:[],synth:[],drums:[{t:0,n:36,vel:100,dur:0.5}]},clips:[],mixer:state.mixer};
const sampleBtn=document.getElementById('sampleBtn');sampleBtn.onclick=()=>{importProject(sampleProject);};

// --- Keyboard shortcuts ---
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;if(e.code==='Space'){e.preventDefault();playBtn.click();}if(e.key==='r'||e.key==='R'){recBtn.click();}if(e.key==='q'||e.key==='Q'){quantizeLast();}});
function quantizeLast(){toast('Quantize not implemented for timeline');}

// --- Init ---
function init(){buildPads();applyState();}
init();
</script>
</body>
</html>
